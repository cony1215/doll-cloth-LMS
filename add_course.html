<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>æ–°å¢/ç·¨è¼¯èª²ç¨‹ - æ£‰å¨ƒæ‰‹ä½œå­¸è‹‘</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; background-color: #fffaf2; margin: 0; padding: 20px; }
    h2 { text-align: center; color: #5a2a19; }
    form { max-width: 600px; margin: auto; background: #fff4ed; padding: 20px; border-radius: 10px; }
    input, textarea, select { width: 100%; margin-bottom: 10px; padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
    button { padding: 10px 20px; border: none; border-radius: 6px; margin: 5px; background-color: #ff9980; color: white; cursor: pointer; }
    .section { margin-bottom: 10px; }
    .danger { background-color: #c0392b; }
    .neutral { background-color: #888; }
  </style>
</head>
<body>
  <h2>ğŸ“˜ æ–°å¢ / ç·¨è¼¯èª²ç¨‹</h2>
  <form id="courseForm">
    <input type="text" id="title" placeholder="èª²ç¨‹æ¨™é¡Œ" required />
    <textarea id="description" placeholder="å½±éŸ³åœ–æ–‡æ•™å­¸èªªæ˜" required></textarea>
    <textarea id="simulateDescription" placeholder="æ¨¡æ“¬æ“ä½œèªªæ˜" required></textarea>
    <input type="text" id="simulateLink" placeholder="æ¨¡æ“¬æ“ä½œé é¢é€£çµ (å¦‚ stitch/stitch-select.html)" required />

    <div id="sectionsContainer"></div>
    <button type="button" onclick="addTextSection()">ï¼‹æ–‡å­—æ®µè½</button>
    <button type="button" onclick="addImageSection()">ï¼‹åœ–ç‰‡æ®µè½</button>
    <button type="button" onclick="addVideoSection()">ï¼‹å½±ç‰‡æ®µè½</button>

    <select id="prerequisite">
      <option value="">ï¼ˆå¯é¸ï¼‰è«‹é¸æ“‡å‰ç½®èª²ç¨‹</option>
    </select>

    <br><br>
    <button type="submit">ğŸ’¾ å„²å­˜èª²ç¨‹</button>
    <button type="button" class="neutral" onclick="cancelEdit()">â†© å–æ¶ˆ</button>
    <button type="button" class="danger" id="deleteBtn" style="display:none" onclick="deleteCourse()">ğŸ—‘ åˆªé™¤èª²ç¨‹</button>
  </form>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC1BqFNd-kwD63_a-2ns6ZlYDKKPL7kIF0",
      authDomain: "doll-cloth-lms.firebaseapp.com",
      projectId: "doll-cloth-lms"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    const editId = urlParams.get("id");

    auth.onAuthStateChanged(async user => {
      if (!user) {
        alert("è«‹å…ˆç™»å…¥");
        window.location.href = "login.html";
        return;
      }

      await loadCourseOptions(); // è¼‰å…¥é¸é …

      if (editId) {
        document.getElementById("deleteBtn").style.display = "inline-block";
        db.collection("courses").doc(editId).get().then(doc => {
          if (doc.exists) {
            const data = doc.data();
            document.getElementById("title").value = data.title || "";
            document.getElementById("description").value = data.description || "";
            document.getElementById("simulateDescription").value = data.simulateDescription || "";
            document.getElementById("simulateLink").value = data.simulateLink || "";
            document.getElementById("prerequisite").value = data.prerequisite || "";

            const container = document.getElementById("sectionsContainer");
            container.innerHTML = "";
            (data.sections || []).forEach(section => {
              const div = document.createElement("div");
              div.className = "section";
              div.dataset.type = section.type;
              if (section.type === "text") {
                div.innerHTML = `<textarea>${section.content}</textarea>`;
              } else {
                div.innerHTML = `<input type="text" value="${section.content}">`;
              }
              container.appendChild(div);
            });
          }
        });
      }

      document.getElementById("courseForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const title = document.getElementById("title").value;
        const description = document.getElementById("description").value;
        const simulateDescription = document.getElementById("simulateDescription").value;
        const simulateLink = document.getElementById("simulateLink").value;
        const prerequisite = document.getElementById("prerequisite").value;

        const sections = Array.from(document.querySelectorAll(".section")).map(sec => ({
          type: sec.dataset.type,
          content: sec.querySelector("input, textarea").value
        }));

        const courseData = {
          title,
          description,
          simulateDescription,
          simulateLink,
          prerequisite,
          sections,
          createdBy: user.uid,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
          if (editId) {
            await db.collection("courses").doc(editId).set(courseData);
            alert("èª²ç¨‹å·²æ›´æ–°ï¼");
          } else {
            await db.collection("courses").add(courseData);
            alert("èª²ç¨‹å·²æ–°å¢ï¼");
          }
          window.location.href = "teacher_dashboard.html";
        } catch (err) {
          console.error("èª²ç¨‹å„²å­˜å¤±æ•—ï¼š", err);
          alert("å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        }
      });
    });

    async function loadCourseOptions() {
      const select = document.getElementById("prerequisite");
      const snapshot = await db.collection("courses").get();
      snapshot.forEach(doc => {
        const data = doc.data();
        const option = document.createElement("option");
        option.value = doc.id;
        option.textContent = data.title || "(æœªå‘½å)";
        select.appendChild(option);
      });


    }

    function cancelEdit() {
      if (confirm("ç¢ºå®šå–æ¶ˆä¸¦è¿”å›è€å¸«å¾Œå°ï¼Ÿ")) {
        window.location.href = "teacher_dashboard.html";
      }
    }

    async function deleteCourse() {
      if (confirm("ç¢ºå®šè¦åˆªé™¤é€™é–€èª²ç¨‹å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚")) {
        await db.collection("courses").doc(editId).delete();
        alert("èª²ç¨‹å·²åˆªé™¤");
        window.location.href = "teacher_dashboard.html";
      }
    }

    function addTextSection() {
      const div = document.createElement("div");
      div.className = "section";
      div.dataset.type = "text";
      div.innerHTML = '<textarea placeholder="æ–‡å­—èªªæ˜"></textarea>';
      document.getElementById("sectionsContainer").appendChild(div);
    }

    function addImageSection() {
      const div = document.createElement("div");
      div.className = "section";
      div.dataset.type = "image";
      div.innerHTML = '<input type="text" placeholder="åœ–ç‰‡ç¶²å€">';
      document.getElementById("sectionsContainer").appendChild(div);
    }

    function addVideoSection() {
      const div = document.createElement("div");
      div.className = "section";
      div.dataset.type = "video";
      div.innerHTML = '<input type="text" placeholder="å½±ç‰‡ç¶²å€">';
      document.getElementById("sectionsContainer").appendChild(div);
    }
  </script>
</body>
</html>
